var Alloy=require("alloy"),_=require("alloy/underscore")._,model,collection;exports.definition={config:{columns:{id:"INTEGER PRIMARY KEY",owner_id:"INTEGER",item_id:"INTEGER",requestor_id:"INTEGER",requestor_name:"TEXT",requestor_img_path:"TEXT",actions:"INTEGER",status:"INTEGER",updated:"TEXT",created:"TEXT",point:"INTEGER"},adapter:{type:"sql",collection_name:"item_response",idAttribute:"id"}},extendModel:function(e){return _.extend(e.prototype,{}),e},extendCollection:function(e){return _.extend(e.prototype,{getData:function(e){var t=this,i=Ti.App.Properties.getString("user_id"),o="SELECT item_response.*, items.item_name, items.img_path FROM "+t.config.adapter.collection_name+" left outer join items on items.id = item_response.item_id where item_response.item_id = ? AND item_response.owner_id = ? AND item_response.status = 0 and item_response.actions = 1";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var a=db.execute(o,e,i),r=[],l=0;a.isValidRow();)r[l]={id:a.fieldByName("id"),item_name:a.fieldByName("item_name"),item_img_path:a.fieldByName("img_path"),point:a.fieldByName("point"),owner_id:a.fieldByName("owner_id"),item_id:a.fieldByName("item_id"),requestor_id:a.fieldByName("requestor_id"),requestor_img_path:a.fieldByName("requestor_img_path"),requestor_name:a.fieldByName("requestor_name")},a.next(),l++;return a.close(),db.close(),t.trigger("sync"),r},getSpendPoint:function(){var e=this,t=Ti.App.Properties.getString("user_id")||0,i="SELECT sum(point) as total FROM "+e.config.adapter.collection_name+" WHERE requestor_id=? AND actions = 1";db=Ti.Database.open(e.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var o,a=db.execute(i,t);return a.isValidRow()&&(o=a.fieldByName("total")||0),a.close(),db.close(),e.trigger("sync"),o},saveArray:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1),db.execute("BEGIN"),e.forEach(function(e){var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, item_id, requestor_id, status, actions, updated, created, requestor_name, requestor_img_path, point) VALUES (?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.item_id,e.requestor_id,e.status,e.actions,e.updated,e.created,e.requestor_name,e.requestor_img_path,e.point);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, item_id=?, requestor_id=?, status=?, actions=?, updated=?, created=?, requestor_name=?, requestor_img_path=?, point=? WHERE id=?";db.execute(i,e.owner_id,e.item_id,e.requestor_id,e.status,e.actions,e.updated,e.created,e.requestor_name,e.requestor_img_path,e.point,e.id)}),console.log(db.getRowsAffected()+"insert into item response 1"),db.execute("COMMIT"),console.log(db.getRowsAffected()+"insert into item response 2"),db.close(),t.trigger("sync")},saveRecord:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, item_id, requestor_id, status, actions, updated, created, requestor_name, requestor_img_path, point) VALUES (?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.item_id,e.requestor_id,e.status,e.actions,e.updated,e.created,e.requestor_name,e.requestor_img_path,e.point);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, item_id=?, requestor_id=?, status=?, actions=?, updated=?, created=?, requestor_name=?, requestor_img_path=?, point=? WHERE id=?";db.execute(i,e.owner_id,e.item_id,e.requestor_id,e.status,e.actions,e.updated,e.created,e.requestor_name,e.requestor_img_path,e.point,e.id),console.log(db.getRowsAffected+"insert into item response"),db.close(),t.trigger("sync")},addColumn:function(e,t){var i=this,o=Ti.Database.open(i.config.adapter.db_name);"android"!=Ti.Platform.osname&&o.file.setRemoteBackup(!1);var a=!1;for(resultSet=o.execute("PRAGMA TABLE_INFO("+i.config.adapter.collection_name+")");resultSet.isValidRow();)resultSet.field(1)==e&&(a=!0),resultSet.next();a||o.execute("ALTER TABLE "+i.config.adapter.collection_name+" ADD COLUMN "+e+" "+t),o.close()}}),e}},model=Alloy.M("item_response",exports.definition,[]),collection=Alloy.C("item_response",exports.definition,model),exports.Model=model,exports.Collection=collection;