var Alloy=require("alloy"),_=require("alloy/underscore")._,model,collection;exports.definition={config:{columns:{id:"INTEGER PRIMARY KEY AUTOINCREMENT",u_id:"INTEGER",to_id:"INTEGER",item_id:"INTEGER",message:"TEXT",read:"INTEGER",type:"TEXT",created:"TEXT"},adapter:{type:"sql",collection_name:"message",idAttribute:"id"}},extendModel:function(e){return _.extend(e.prototype,{}),e},extendCollection:function(e){return _.extend(e.prototype,{getData:function(e){var t=this,i="SELECT message.*, friends.thumb_path FROM message LEFT OUTER JOIN friends on friends.f_id = message.u_id WHERE message.item_id = ? order by message.created";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var a=db.execute(i,e),o=[],r=0,l=a.fieldCount,n=0;l>n;n++)console.log(n+":"+a.fieldName(n)+":"+a.field(n));for(;a.isValidRow();)o[r]={id:a.fieldByName("id"),u_id:a.fieldByName("u_id"),to_id:a.fieldByName("to_id"),item_id:a.fieldByName("item_id"),message:a.fieldByName("message"),thumb_path:a.fieldByName("thumb_path"),type:a.fieldByName("type"),created:a.fieldByName("created")},a.next(),r++;return a.close(),db.close(),t.trigger("sync"),o},getData_deprecated:function(e){var t=Ti.App.Properties.getString("user_id")||0,i=this,a="SELECT message.*, friends.thumb_path FROM message LEFT OUTER JOIN friends on friends.f_id = message.u_id WHERE (message.u_id=? AND message.to_id=?) OR (message.u_id=? AND message.to_id=?) order by message.created DESC";db=Ti.Database.open(i.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var o=db.execute(a,t,e,e,t),r=[],l=0;o.isValidRow();)r[l]={id:o.fieldByName("id"),u_id:o.fieldByName("u_id"),to_id:o.fieldByName("to_id"),message:o.fieldByName("message"),thumb_path:o.fieldByName("thumb_path"),type:o.fieldByName("type"),created:o.fieldByName("created")},o.next(),l++;return o.close(),db.close(),i.trigger("sync"),r},getDataUnread:function(){var e=Ti.App.Properties.getString("user_id")||0,t=this,i="select count(*) as total, u_id from message where to_id = ? AND read is null group by u_id";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var a=db.execute(i,e),o=[],r=0;a.isValidRow();)o[r]={id:a.fieldByName("total"),u_id:a.fieldByName("u_id")},a.next(),r++;return a.close(),db.close(),t.trigger("sync"),o},messageRead:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var i="UPDATE "+t.config.adapter.collection_name+" SET read=1 WHERE item_id=?";db.execute(i,e.item_id),console.log(db.getRowsAffected()+" "+e.item_id+" read"),db.close(),t.trigger("sync")},saveArray:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1),db.execute("BEGIN"),e.forEach(function(e){var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (name, u_id) VALUES (?,?)";db.execute(i,e.name,e.u_id);var i="UPDATE "+t.config.adapter.collection_name+" SET name=? WHERE u_id=?";db.execute(i,e.name,e.u_id)}),db.execute("COMMIT"),db.close(),t.trigger("sync")},saveRecord:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (u_id, to_id, message, type,item_id, created) VALUES (?,?,?,?,?,?)";db.execute(i,e.u_id,e.to_id,e.message,e.type,e.item_id,Common.now()),db.close(),t.trigger("sync")},addColumn:function(e,t){var i=this,a=Ti.Database.open(i.config.adapter.db_name);"android"!=Ti.Platform.osname&&a.file.setRemoteBackup(!1);var o=!1;for(resultSet=a.execute("PRAGMA TABLE_INFO("+i.config.adapter.collection_name+")");resultSet.isValidRow();)resultSet.field(1)==e&&(o=!0),resultSet.next();o||a.execute("ALTER TABLE "+i.config.adapter.collection_name+" ADD COLUMN "+e+" "+t),a.close()}}),e}},model=Alloy.M("message",exports.definition,[]),collection=Alloy.C("message",exports.definition,model),exports.Model=model,exports.Collection=collection;