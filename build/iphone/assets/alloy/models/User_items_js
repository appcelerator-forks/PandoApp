var Alloy=require("alloy"),_=require("alloy/underscore")._,model,collection;exports.definition={config:{columns:{id:"INTEGER PRIMARY KEY AUTOINCREMENT",u_id:"INTEGER",i_id:"INTEGER",action:"TEXT",status:"INTEGER",updated:"TEXT",created:"TEXT"},adapter:{type:"sql",collection_name:"user_items",idAttribute:"id"}},extendModel:function(e){return _.extend(e.prototype,{}),e},extendCollection:function(e){return _.extend(e.prototype,{getData:function(){var e=this,t="SELECT * FROM userItems where status = 1";db=Ti.Database.open(e.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var i=db.execute(t),o=[],a=0;i.isValidRow();)o[a]={id:i.fieldByName("id"),u_id:i.fieldByName("u_id"),i_id:i.fieldByName("i_id"),action:i.fieldByName("action"),status:i.fieldByName("status")},i.next(),a++;return i.close(),db.close(),e.trigger("sync"),o},calculate_distance:function(){var e=this,t="SELECT * FROM "+e.config.adapter.collection_name+" where distance = '' OR distance IS NULL";db=Ti.Database.open(e.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var i=Ti.App.Properties.getString("longitude")||0,o=Ti.App.Properties.getString("latitude")||0,a=db.execute(t),r=0;a.isValidRow();)lon1=a.fieldByName("longitude"),lat1=a.fieldByName("latitude"),countDistanceByKM(lon1,lat1,i,o),a.next(),r++;Ti.App.fireEvent("app:update_loading_text",{text:"Calculating distance..."}),Ti.App.fireEvent("app:next_loading")},saveArray:function(e){console.log("item save array"),console.log(e);var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1),db.execute("BEGIN"),e.forEach(function(e){var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, receiver_id, item_name, item_desc, item_category, longitude, latitude, status, created, updated, owner_name, owner_img_path, img_path) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, receiver_id=?, item_name=?, item_desc=?, item_category=?, longitude=?, latitude=?, status=?, created=?, updated=?, owner_name=?, owner_img_path=?, img_path=? WHERE id=?";db.execute(i,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.id)}),db.execute("COMMIT"),db.close(),t.trigger("sync")},markRead:function(e){var t=this,i=Ti.App.Properties.getString("user_id");db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var o="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (u_id, i_id, action, status, updated, created) VALUES (?,?,?,?,?,?)";db.execute(o,i,e.id,e.action,1,Common.now(),Common.now()),db.close(),t.trigger("sync")},saveRecord:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, receiver_id, item_name, item_desc, item_category, longitude, latitude, status, created, updated, owner_name, owner_img_path, img_path) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, receiver_id=?, item_name=?, item_desc=?, item_category=?, longitude=?, latitude=?, status=?, created=?, updated=?, owner_name=?, owner_img_path, img_path=? WHERE id=?";db.execute(i,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.id),db.close(),t.trigger("sync")}}),e}};var countDistanceByKM=function(e,t,i,o){var a=6371,r=(i-e)*Math.PI/180,l=(o-t)*Math.PI/180,n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2),d=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),s=a*d;return s>1?Math.round(s):1>=s?Math.round(1e3*s)+"m":s};model=Alloy.M("user_items",exports.definition,[]),collection=Alloy.C("user_items",exports.definition,model),exports.Model=model,exports.Collection=collection;