var Alloy=require("alloy"),_=require("alloy/underscore")._,model,collection;exports.definition={config:{columns:{id:"INTEGER PRIMARY KEY ",owner_id:"INTEGER",receiver_id:"INTEGER",item_name:"TEXT",img_path:"TEXT",item_desc:"TEXT",item_category:"TEXT",longitude:"TEXT",latitude:"TEXT",status:"INTEGER",created:"TEXT",code:"TEXT",updated:"TEXT",owner_name:"TEXT",owner_img_path:"TEXT",distance:"TEXT",point:"INTEGER"},adapter:{type:"sql",collection_name:"items",idAttribute:"id"}},extendModel:function(e){return _.extend(e.prototype,{}),e},extendCollection:function(e){return _.extend(e.prototype,{getData:function(){var e=Ti.App.Properties.getString("user_id")||0,t=this,i="select * from items where id not in (SELECT item_id FROM item_response where requestor_id = ?) AND status = 1 AND owner_id != ? order by created desc";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var o=db.execute(i,e,e),a=[],r=0;o.isValidRow();)a[r]={id:o.fieldByName("id"),owner_id:o.fieldByName("owner_id"),receiver_id:o.fieldByName("receiver_id"),item_name:o.fieldByName("item_name"),item_desc:o.fieldByName("item_desc"),item_category:o.fieldByName("item_category"),longitude:o.fieldByName("longitude"),latitude:o.fieldByName("latitude"),status:o.fieldByName("status"),created:o.fieldByName("created"),updated:o.fieldByName("updated"),owner_name:o.fieldByName("owner_name"),owner_img_path:o.fieldByName("owner_img_path"),img_path:o.fieldByName("img_path"),code:o.fieldByName("code")},o.next(),r++;return o.close(),db.close(),t.trigger("sync"),a},getDataById:function(e){var t=this,i="SELECT * FROM "+t.config.adapter.collection_name+" WHERE id='"+e+"'";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var o=db.execute(i),a=[];return o.isValidRow()&&(a={id:o.fieldByName("id"),owner_id:o.fieldByName("owner_id"),receiver_id:o.fieldByName("receiver_id"),item_name:o.fieldByName("item_name"),item_desc:o.fieldByName("item_desc"),item_category:o.fieldByName("item_category"),longitude:o.fieldByName("longitude"),latitude:o.fieldByName("latitude"),status:o.fieldByName("status"),created:o.fieldByName("created"),updated:o.fieldByName("updated"),owner_name:o.fieldByName("owner_name"),owner_img_path:o.fieldByName("owner_img_path"),img_path:o.fieldByName("img_path"),code:o.fieldByName("code")}),o.close(),db.close(),t.trigger("sync"),a},getDataByFid:function(e){var t=Ti.App.Properties.getString("user_id")||0,i=this,o="select items.*, fm.total from items LEFT OUTER JOIN (select count(*) as total, u_id, item_id from message where u_id = ? AND (read is null OR read != 1) group by item_id) as fm on items.id = fm.item_id where (items.status = 2 OR items.status = 5) AND (( items.owner_id = ? AND items.receiver_id = ?) OR ( items.owner_id = ? AND items.receiver_id = ?)) order by items.created desc";db=Ti.Database.open(i.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1),console.log(o+" "+t+" "+e);for(var a=db.execute(o,e,e,t,t,e),r=[],l=0,n=a.fieldCount,s=0;n>s;s++)console.log(s+":"+a.fieldName(s)+":"+a.field(s));for(;a.isValidRow();)r[l]={id:a.fieldByName("id"),owner_id:a.fieldByName("owner_id"),receiver_id:a.fieldByName("receiver_id"),item_name:a.fieldByName("item_name"),item_desc:a.fieldByName("item_desc"),item_category:a.fieldByName("item_category"),longitude:a.fieldByName("longitude"),latitude:a.fieldByName("latitude"),status:a.fieldByName("status"),created:a.fieldByName("created"),updated:a.fieldByName("updated"),owner_name:a.fieldByName("owner_name"),owner_img_path:a.fieldByName("owner_img_path"),img_path:a.fieldByName("img_path"),total:a.fieldByName("total"),code:a.fieldByName("code")},a.next(),l++;return a.close(),db.close(),i.trigger("sync"),r},getMatchingDataByOwner:function(){var e=Ti.App.Properties.getString("user_id"),t=this,i="select match_item.*, friends.fullname from (select items.*, ir.total from items left outer join (select count(*) as total, message.u_id from message where message.to_id = ? AND message.read is null group by message.u_id) as ir on items.receiver_id = ir.u_id where (items.status = 2) AND items.owner_id = ? AND receiver_id != 0) as match_item left outer join friends ON friends.f_id = match_item.receiver_id ";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var o=db.execute(i,e,e),a=[],r=0;o.isValidRow();)a[r]={total:o.fieldByName("total"),id:o.fieldByName("id"),owner_id:o.fieldByName("owner_id"),receiver_id:o.fieldByName("receiver_id"),receiver_name:o.fieldByName("friends.fullname"),item_name:o.fieldByName("item_name"),item_desc:o.fieldByName("item_desc"),item_category:o.fieldByName("item_category"),longitude:o.fieldByName("longitude"),latitude:o.fieldByName("latitude"),status:o.fieldByName("status"),created:o.fieldByName("created"),updated:o.fieldByName("updated"),owner_name:o.fieldByName("owner_name"),owner_img_path:o.fieldByName("owner_img_path"),img_path:o.fieldByName("img_path"),code:o.fieldByName("code")},o.next(),r++;return o.close(),db.close(),t.trigger("sync"),a},getWaitingDataByOwner:function(){var e=Ti.App.Properties.getString("user_id"),t=this,i="select items.*, ir.total from items left outer join (SELECT item_id, count(*) as total FROM item_response where owner_id = ? and actions = 1 and status = 0 group by item_id) as ir on items.id = ir.item_id where items.status = 1 AND items.owner_id = ? AND receiver_id = 0";db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var o=db.execute(i,e,e),a=[],r=0;o.isValidRow();)a[r]={total:o.fieldByName("total"),id:o.fieldByName("id"),owner_id:o.fieldByName("owner_id"),receiver_id:o.fieldByName("receiver_id"),item_name:o.fieldByName("item_name"),item_desc:o.fieldByName("item_desc"),item_category:o.fieldByName("item_category"),longitude:o.fieldByName("longitude"),latitude:o.fieldByName("latitude"),status:o.fieldByName("status"),created:o.fieldByName("created"),updated:o.fieldByName("updated"),owner_name:o.fieldByName("owner_name"),owner_img_path:o.fieldByName("owner_img_path"),img_path:o.fieldByName("img_path"),code:o.fieldByName("code")},o.next(),r++;return o.close(),db.close(),t.trigger("sync"),a},calculate_distance:function(){console.log("calculate_distance");var e=this,t="SELECT * FROM "+e.config.adapter.collection_name+" where distance = '' OR distance IS NULL";db=Ti.Database.open(e.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);for(var i=Ti.App.Properties.getString("longitude")||0,o=Ti.App.Properties.getString("latitude")||0,a=db.execute(t),r=0;a.isValidRow();)lon1=a.fieldByName("longitude"),lat1=a.fieldByName("latitude"),countDistanceByKM(lon1,lat1,i,o),a.next(),r++;db.close(),e.trigger("sync"),Ti.App.fireEvent("app:update_loading_text",{text:"Calculating distance..."}),Ti.App.fireEvent("app:next_loading")},saveArray:function(e){console.log("item save array");var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1),db.execute("BEGIN"),e.forEach(function(e){var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, receiver_id, item_name, item_desc, item_category, longitude, latitude, status, created, updated, owner_name, owner_img_path, img_path, code, point) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.code,e.point);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, receiver_id=?, item_name=?, item_desc=?, item_category=?, longitude=?, latitude=?, status=?, created=?, updated=?, owner_name=?, owner_img_path=?, img_path=?, code=?, point=? WHERE id=?";db.execute(i,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.code,e.point,e.id)}),db.execute("COMMIT"),db.close(),t.trigger("sync")},saveRecord:function(e){var t=this;db=Ti.Database.open(t.config.adapter.db_name),"android"!=Ti.Platform.osname&&db.file.setRemoteBackup(!1);var i="INSERT OR IGNORE INTO "+t.config.adapter.collection_name+" (id, owner_id, receiver_id, item_name, item_desc, item_category, longitude, latitude, status, created, updated, owner_name, owner_img_path, img_path, code, point) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";db.execute(i,e.id,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.code,e.point);var i="UPDATE "+t.config.adapter.collection_name+" SET owner_id=?, receiver_id=?, item_name=?, item_desc=?, item_category=?, longitude=?, latitude=?, status=?, created=?, updated=?, owner_name=?, owner_img_path=?, img_path=?, code=?, point=? WHERE id=?";db.execute(i,e.owner_id,e.receiver_id,e.item_name,e.item_desc,e.item_category,e.longitude,e.latitude,e.status,e.created,e.updated,e.owner_name,e.owner_img_path,e.img_path,e.code,e.point,e.id),db.close(),t.trigger("sync")},addColumn:function(e,t){var i=this,o=Ti.Database.open(i.config.adapter.db_name);"android"!=Ti.Platform.osname&&o.file.setRemoteBackup(!1);var a=!1;for(resultSet=o.execute("PRAGMA TABLE_INFO("+i.config.adapter.collection_name+")");resultSet.isValidRow();)resultSet.field(1)==e&&(a=!0),resultSet.next();a||o.execute("ALTER TABLE "+i.config.adapter.collection_name+" ADD COLUMN "+e+" "+t),o.close()}}),e}};var countDistanceByKM=function(e,t,i,o){var a=6371,r=(i-e)*Math.PI/180,l=(o-t)*Math.PI/180,n=Math.sin(r/2)*Math.sin(r/2)+Math.cos(e*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2),s=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),_=a*s;return _>1?Math.round(_):1>=_?Math.round(1e3*_)+"m":_};model=Alloy.M("items",exports.definition,[]),collection=Alloy.C("items",exports.definition,model),exports.Model=model,exports.Collection=collection;